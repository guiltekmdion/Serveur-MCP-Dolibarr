name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check TypeScript compilation
      run: npm run build

    - name: Run API audit
      id: audit
      run: |
        npm run audit:api > audit_output.txt 2>&1 || true
        cat audit_output.txt
        
        if grep -q "AUCUN PROBLÃˆME DÃ‰TECTÃ‰" audit_output.txt; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… API Standards: PASS" >> $GITHUB_STEP_SUMMARY
        else
          echo "status=warning" >> $GITHUB_OUTPUT
          echo "âš ï¸ API Standards: Warnings detected" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat audit_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check for sensitive files
      run: |
        if [ -f .env ]; then
          echo "âŒ .env file found in repository!"
          exit 1
        fi
        
        if [ -d logs/ ]; then
          echo "âŒ logs/ directory found in repository!"
          exit 1
        fi
        
        echo "âœ… No sensitive files detected"

    - name: Validate CHANGELOG updated
      run: |
        if git diff --name-only origin/main...HEAD | grep -q "CHANGELOG.md"; then
          echo "âœ… CHANGELOG.md updated"
        else
          echo "âš ï¸ Consider updating CHANGELOG.md"
        fi

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag mcp-dolibarr:pr-${{ github.event.pull_request.number }}

    - name: PR Summary
      run: |
        echo "## ðŸ“‹ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TypeScript compilation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker build" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… No sensitive files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Ready for review! ðŸš€" >> $GITHUB_STEP_SUMMARY
